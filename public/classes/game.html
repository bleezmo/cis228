<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Click-A-Marx</title>
    <meta charset="utf-8">

    <style>
      body {
        background-color : #CFF ;
      }
      .square {
        font-size : 5em ;
        font-weight : bold ;
        font-family : "Last Ninja", "Engravers MT", "Braggadocio", fantasy ;
        border : 0.2em solid yellow ;
        color : blue ;
        background : url(mole.png) no-repeat center ;
        opacity : 0.7 ;
      }
      .hot {
        border : 0.2em solid red;
        background : url(marx.png) no-repeat center ;
        opacity : 0.7 ;
      }
      .blink, .hot {
        text-decoration : blink ;
      }
      .negative {
        color : red ;
      }
      #table {
        background-color : #CFC ;
      }
      #timer {
         float : left ;
      }
      #scoreboard {
         float : right ;
      }
    </style>

    <script>

      var score;
      var scores;
      var prev;
      var name;
      var rows;
      var cols;
      var over;
      var time;
      var timer;
      var seconds = 45;
 //   var seconds = 30;
      var factor;
      var hot = {};

      onload = function () {
        var scores = readScores();
        for (i in scores) {
           postScore(scores[i]);
        }
      }

      function readScores() {
 //     if (localStorage) alert("local storage");
 //     else if (sessionStorage) alert("session storage");
 //     else alert("no persistant storage");
        var oldScores;
        if (localStorage) oldScores = localStorage["old scores"];
        else if (sessionStorage) oldScores = sessionStorage["old scores"];
        if (oldScores) JSON.parse(oldScores);
        return [];
      }

      function saveScores() {
        oldScores = JSON.stringify(scores);
        if (localStorage) localStorage["old scores"] = oldScores;
        if (sessionStorage) sessionStorage["old scores"] = oldScores;
      }

      function makeScore() {
        li = document.createElement("li");
        var today = new Date();
        var date  = (1+today.getMonth())+"/"+today.getDay()+"/"+today.getFullYear();
        var line = score+" for player "+name+" on "+rows+"x"+cols+" board on "+date+".";
        li.innerHTML = line;
        return li;
      }

      function postScore(score) {
        if (!prev) {
          var div = document.getElementById("previous");
          var h3 = document.createElement("h3");
          h3.innerHTML = "Previous Scores";
          div.appendChild(h3);
          prev = document.createElement("ul");
          div.appendChild(prev);
        }
        prev.appendChild(score);
        scores.push(score);
        saveScores();
      }

      function setScore(sq) {
        var s = Math.random() + Math.random();
        s = 9.5*(s-1);
        s = Math.round(s);
        if (s < 0) {
          s = -s;
          addClass(sq, "negative");
        } else {
          delClass(sq, "negative");
        }
        setValue(sq, s);
      }

      function getScore(square) {
        if (over) return;
        var i = getValue(square);
        if (hasClass(square, "negative")) {
          i = -i;
        }
        if (isHot(square)) {
           makeCold(square);
           makeHot(randomSquare());
           i = i*2 + 7;
        }
        score += Math.floor(factor*i);
        document.getElementById("scoreboard").innerHTML = "score: " +score;
        setScore(square);
      }

      function setValue(sq, v) {
        sq.innerHTML = "&nbsp;"+v+"&nbsp;";
      }

      function getValue(sq) {
        var s = sq.innerHTML;
        var i = parseInt(s);
        while (s && !(-10 < i && i < 10)) {
          s = s.substring(1);
          i = parseInt(s);
        }
        return i;
      }

      function play() {
        setup();
        start();
      }

      function start() {
        over  = false;
        time  = seconds;
        timer = setInterval(tick, 1000); 
        addClass(document.getElementById("title"), "blink");
        makeHot(randomSquare());
      }

      function tick() {
        time = time - 1;
        if (0 < time) {
          document.getElementById("timer").innerHTML = time+" seconds remaining";
          if (seconds/3 == time || seconds/5 == time) {
            makeHot(randomSquare());
          }
          setScore(randomSquare());
        } else if (0 == time) {
          stop();
        } else {
          over = true;
          document.getElementById("timer").innerHTML = "";
          clearInterval(timer);
        }
      }

      function stop() {
        over = true;
        var title = document.getElementById("title");
        title.innerHTML = name+"'s game is over.";
        delClass(title, "blink");
        var squares = getHotSquares();
        for (i in squares) {
          makeCold(squares[i]);
        }
        postScore(makeScore());
        alert(name + ", your score is " + score);
      }

      function setup() {
        score = 0;
        name = document.getElementById("player").value;
        while (!name) {
          name = prompt("Enter a valid name");
        }
        rows = parseInt(document.getElementById("rows").value);
        while (!rows || !(0 < rows && rows < 100)) {
          rows = parseInt(prompt("Enter a valid number of rows (0 < rows < 100)"));
        }
        cols = parseInt(document.getElementById("cols").value);
        while (!cols || !(0 < cols && cols < 100)) {
          cols = parseInt(prompt("Enter a valid number of cols (0 < cols < 100)"));
        }
        factor = Math.sqrt(rows*cols);
        makeBoard();
      }
 
      function makeBoard() {
        var table   = document.getElementById("table");
        var caption = document.createElement("caption");
        var board   = document.createElement("tbody");
        var time    = "<span id=\"timer\"></span>"
        var title   = "<span id=\"title\">"+name+" is playing.</span>";
        var score   = "<span id=\"scoreboard\"></span>";
        caption.innerHTML = time+title+score;
        for (var r=0; r<rows; r++) {
          row = document.createElement("tr");
          for (var c=0; c<cols; c++) {
            col = makeSquare(r, c);
            row.appendChild(col)
          }
          board.appendChild(row);
        }
        table.innerHTML = null;
        table.appendChild(caption);
        table.appendChild(board);
      }
     
      function makeSquare(r, c) {
        var sq = document.createElement("td");
        sq.setAttribute("id", makeId(r, c));
        sq.setAttribute("onclick", "getScore(this);");
        addClass(sq, "square");
        setScore(sq);
        return sq;
      }

      function isHot(square) {
        return hasClass(square, "hot");
      }

      function makeHot(square) {
        addClass(square, "hot");
      }

      function makeCold(square) {
        delClass(square, "hot");
      }

      function getHotSquares() {
        var result = [];
        for (var r=0; r<rows; r++) {
          for (var c=0; c<cols; c++) {
            var id = makeId(r, c);
            var sq = document.getElementById(id);
            if (isHot(sq)) {
              result.push(sq);
            }
          }
        }
        return result;
      }

      function makeId(r, c) {
        return "sq_"+r+"_"+c;
      }

      function random(n) {
        return Math.floor(n*Math.random());
      }

      function randomSquare() {
        return document.getElementById(makeId(random(rows), random(cols)));
      }

      function getClasses(elem) {
        if (!elem.getAttribute) return null;
        return elem.getAttribute("class");
      }

      function hasClass(elem, c) {
        var classes = getClasses(elem);
        if (!classes) return false;
        return -1 < classes.indexOf(c);
      }

      function addClass(elem, c) {
        elem.setAttribute("class", (getClasses(elem) || "") + " " + c);
      }

      function delClass(elem, c) {
        elem.setAttribute("class", (getClasses(elem) || "").split(c).join(" "));
      }

      document.getElementsByClassName = function(name) {
        var result = [];
        var elements = this.getElementsByTagName("*");
        for (var i in elements) {
          if (hasClass(elements[i], name)) {
            result.push(elements[i]);
          }
        }
        return result;
      };

    </script>
  </head>
  <body>
    <h1>Click-A-Marx</h1>
    <form>
      <p>
        name: <input type="text" id="player" value="player">
        rows: <input type="text" size="2" id="rows" value="3"> 
        cols: <input type="text" size="2" id="cols" value="4">
        <input type="button" value="play" onclick="play()">
      </p>
    </form>
    <table id="table"></table>
    <div id="previous"></div>
  </body>
</html>
    
